<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head th:replace="~{fragments/head :: head(title='Home')}"></head>

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<body>
<!-- Include the navbar -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-4">
    <div class="row">
        <!-- Left Section: Personal Profile -->
        <div class="col-md-4">
            <div class="card">
                <img src="/images/avatar.jpg" class="card-img-top rounded-circle mx-auto d-block mt-3" style="width: 100px;" alt="Profile Avatar">
                <div class="card-body text-center">
                    <h5 class="card-title" th:text="${user.username}">Your Name</h5>
<!--                    <p class="card-text" th:text="${user.jobTitle}">Your basic information (e.g., job title, location)</p>-->
                    <a th:href="@{/profile}" class="btn btn-primary btn-sm">View Profile</a>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Connections</h5>
                    <ul class="list-group list-group-flush">
<!--                        <li class="list-group-item" th:each="connection : ${connections}" th:text="${connection.name}">John Doe</li>-->
                    </ul>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Suggested Jobs</h5>
                    <ul class="list-group list-group-flush">
<!--                        <li class="list-group-item" th:each="job : ${suggestedJobs}" th:text="${job.title}">Software Engineer at XYZ</li>-->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right Section: Post Writing -->
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-4">Write a Post</h5>
                    <form id="postForm">
                        <div class="form-group mb-3">
                            <!-- Quill Editor -->
                            <div id="editor-container" style="height: 150px;"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Post</button>
                    </form>
                </div>
            </div>

            <!-- Posts Section -->
            <div id="posts-section">
                <!-- New posts will appear here dynamically -->
                    <ul>
                        <li th:each="post : ${posts}">
                            <div class="card" th:data-id="${post.id}">
                                <div class="card-body">
                                    <p th:text="${post.content}">Post content goes here...</p>
                                    <small th:text="${post.createdAt}">Created At</small>
                                </div>
                            </div>
                        </li>
                    </ul>

            </div>
        </div>
    </div>
</div>

<!-- Modal for Editing Posts -->
<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-editor-container" style="height: 200px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="savePost()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // Initialize Quill editors
    // Initialize Quill editors
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'blockquote'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'image'],
                [{ 'align': [] }],
                ['code-block'],
            ]
        }
    });

    var quillModal = new Quill('#modal-editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'blockquote'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'image'],
                [{ 'align': [] }],
                ['code-block'],
            ]
        }
    });

    // Handle form submission
    document.getElementById('postForm').addEventListener('submit', function(event) {
        event.preventDefault();
        var postContent = quill.root.innerHTML;

        console.log('Form Submitted. Post Content:', postContent); // Debugging

        fetch('/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
            },
            body: JSON.stringify({ content: postContent })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Post Created:', data);
                var postElement = createPostElement(data);
                document.getElementById('posts-section').prepend(postElement);
            })

            .catch(error => console.error('Error:', error));
    });

    // Create post element function
    function createPostElement(post) {
        var postElement = document.createElement('div');
        postElement.classList.add('card', 'mb-3');
        postElement.setAttribute('data-id', post.id);

        postElement.innerHTML = `
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    <img src="${post.avatarUrl}" alt="User Image" class="rounded-circle" width="48" height="48">
                </div>
                <div>
                    <h5 class="mb-0">
                        <a href="#" class="text-dark fw-bold">${post.name}</a>
                        <span class="text-muted">• You</span>
                    </h5>
                    <small class="text-muted">${post.basicInfo}</small><br>
                    <small class="text-muted">${post.createdAt} • <i class="bi bi-globe-americas"></i></small>
                </div>
                <div class="ms-auto dropdown">
                    <button class="btn btn-link text-muted dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="material-symbols-outlined">more_horiz</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="#" onclick="editPost('${post.id}', '${post.content}')"><span class="material-symbols-outlined">edit</span>Edit</a></li>
                        <li><a class="dropdown-item" href="#" onclick="deletePost('${post.id}')"><span class="material-symbols-outlined">delete</span>Delete</a></li>
                    </ul>
                </div>
            </div>
            <div class="mb-3">
                <p>${post.content}</p>
            </div>
            <div class="d-flex justify-content-between border-top pt-2">
                <button class="btn btn-light d-flex align-items-center">
                    <span class="material-symbols-outlined">thumb_up</span>Like
                </button>
                <button class="btn btn-light d-flex align-items-center">
                    <span class="material-symbols-outlined">comment</span> Comment
                </button>
            </div>
        </div>
    `;

        return postElement;
    }

    // Edit post function
    function editPost(postId, postContent) {
        console.log('Editing post with ID:', postId);
        quillModal.root.innerHTML = postContent;

        var editPostModal = new bootstrap.Modal(document.getElementById('editPostModal'));
        editPostModal.show();

        window.currentPostId = postId;
    }

    // Save post function
    function savePost() {
        var updatedContent = quillModal.root.innerHTML;
        console.log('Updated Content:', updatedContent);

        fetch(`/posts/${window.currentPostId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value || '[YOUR_CSRF_TOKEN_HERE]'
            },
            body: JSON.stringify({ content: updatedContent })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Post Updated:', data);

                var postElement = document.querySelector(`.card[data-id='${window.currentPostId}']`);
                if (postElement) {
                    var postContentElement = postElement.querySelector('.mb-3 p');
                    if (postContentElement) {
                        postContentElement.innerHTML = updatedContent;
                        console.log('Post Content Updated in DOM');
                    } else {
                        console.error('Post content element not found');
                    }
                } else {
                    console.error('Post element not found');
                }

                var editPostModal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
                editPostModal.hide();
            })
            .catch(error => console.error('Error:', error));
    }

    // Delete post function
    function deletePost(postId) {
        fetch(`/posts/${postId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '[YOUR_CSRF_TOKEN_HERE]'
            }
        })
            .then(() => {
                var postElement = document.querySelector(`.card[data-id='${postId}']`);
                if (postElement) {
                    postElement.remove();
                } else {
                    console.error('Post element not found for deletion');
                }
            })
            .catch(error => console.error('Error:', error));
    }

</script>
</body>
</html>
